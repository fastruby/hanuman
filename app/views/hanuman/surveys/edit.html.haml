- content_for :navbar_hanuman do
  active
- content_for :navbar_hanuman_surveys do
  active
- content_for :survey_form_state do
  Edit Report Entry

- if @survey.errors.any?
  - flash.now[:alert] = @survey.errors.full_messages.join(', ').to_s

- current_step = params[:step].to_i
- current_set = params[:set].to_i
- survey_form_state = yield(:survey_form_state).strip

= form_for @survey, builder: CustomFieldsFormBuilder, html: {class: "form-horizontal"} do |f|

  .page-header
    %h5
      Mode:
      %i= survey_form_state
    %h1= f.object.survey_template.name

  = f.hidden_field :survey_template_id
  = f.hidden_field :id unless @survey.new_record?

  -# if step 1 then call form extension partial to include any survey level fields extended by the parent app
  - if current_step == 1
    = render ("hanuman/surveys/formextension"), f: f

  -# loop through observations
  -# if current step and set = observation step and set make editable, otherwise make readonly
  - index_offset = 0

  -# this section handles edit on already saved data (a true edit)
  - steps = @survey.survey_template.steps
  - steps.each do |step|
    - step_observations = @survey.observations.filtered_by_step(step)
    - unless step_observations.blank?
      - if step_observations.first.survey_question.duplicator
        - sets = @survey.observations.filtered_by_step(step).sets
        - sets.each do |set|
          - set_observations = @survey.observations.filtered_by_step_and_set(step, set)
          - if current_step == step and current_set == set
            - set_observations.each_with_index do |o, index|
              = f.fields_for :observations, o do |ff|
                .form-entry-item-container
                  = ff.hidden_field :survey_question_id
                  = render ("hanuman/surveys/fields/" + ff.object.survey_question.question.answer_type.name), ff: ff, index: (index - index_offset) rescue render "hanuman/surveys/fields/rescue/notsupported", ff: ff, index: (index - index_offset)
          - else
            = render ("hanuman/surveys/fields/readonly/shared/panel"), show: false, survey: @survey, observations: set_observations, step: step, set: set
      - else
        - set = step_observations.first.set
        - if current_step == step
          - step_observations.each_with_index do |o, index|
            = f.fields_for :observations, o do |ff|
              .form-entry-item-container
                = ff.hidden_field :survey_question_id
                = render ("hanuman/surveys/fields/" + ff.object.survey_question.question.answer_type.name), ff: ff, index: (index - index_offset) rescue render "hanuman/surveys/fields/rescue/notsupported", ff: ff, index: (index - index_offset)
        - else
          = render ("hanuman/surveys/fields/readonly/shared/panel"), show: false, survey: @survey, observations: step_observations, step: step, set: set

  -# this section handles edit on newly created data for steps 2, 3, ... as part of our hacked in step by step wizard
  - @survey.observations.each_with_index do |o, index|
    -# if the current observation group is the last observation group render observations as form fields
    - if o.id.blank?
      = f.fields_for :observations, o do |ff|
        .form-entry-item-container
          = ff.hidden_field :survey_question_id
          = render ("hanuman/surveys/fields/" + ff.object.survey_question.question.answer_type.name), ff: ff, index: (index - index_offset) rescue render "hanuman/surveys/fields/rescue/notsupported", ff: ff, index: (index - index_offset)
    - else
      - index_offset += 1


  .form-group
    .col-sm-offset-5.col-sm-7
      - if current_step == 2
        = link_to "#", class: "btn btn-primary ajax-submit" do
          %span.glyphicon.glyphicon-plus
          Save & Add Entry
        = f.submit "Save & Continue", class: "btn btn-primary"
      - else
        = f.submit (current_step == 1 ? "Save & Continue" : "Finish"), class: "btn btn-primary"
